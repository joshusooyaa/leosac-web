{% extends "base.html" %}

{% block content %}
<div class="container-fluid">
  <div class="row">
    <div class="col-12">
      <div class="card">
        <div class="card-header">
          <h3 class="card-title">Edit Schedule: {{ schedule.name }}</h3>
        </div>
        <div class="card-body">
          <form method="POST" id="scheduleForm">
            <div class="form-group">
              <label for="name">Schedule Name *</label>
              <input type="text" class="form-control" id="name" name="name" 
                     value="{{ schedule.name }}"
                     placeholder="Enter schedule name (3-50 characters, no spaces)" 
                     pattern="[a-zA-Z0-9_.-]+" title="Only letters, numbers, underscores, hyphens, and periods are allowed"
                     required minlength="3" maxlength="50">
              <small class="form-text text-muted">
                Schedule name must be between 3 and 50 characters long. Only letters, numbers, underscores (_), hyphens (-), and periods (.) are allowed. No spaces.
              </small>
            </div>
            
            <div class="form-group">
              <label for="description">Description</label>
              <textarea class="form-control" id="description" name="description" 
                        rows="3" placeholder="Enter schedule description (optional)">{{ schedule.description or '' }}</textarea>
              <small class="form-text text-muted">
                Optional description for this schedule.
              </small>
            </div>
            
            <hr>
            
            <!-- Timeframes Section -->
            <div class="form-group">
              <h5>Timeframes</h5>
              <p class="text-muted">Define when this schedule is active. Each timeframe can be enabled for specific days of the week.</p>
              
              <div id="timeframesContainer">
                {% if schedule.timeframes %}
                  {% for timeframe in schedule.timeframes %}
                    <div class="timeframe-panel card mb-3" data-timeframe-id="{{ loop.index0 }}">
                      <div class="card-header">
                        <h6 class="mb-0">Timeframe {{ loop.index }}</h6>
                        <button type="button" class="btn btn-sm btn-danger float-right remove-timeframe">
                          <i class="fas fa-trash"></i> Remove
                        </button>
                      </div>
                      <div class="card-body">
                        <div class="row">
                          <div class="col-md-6">
                            <label>Days of Week</label>
                            <div class="form-check">
                              <input class="form-check-input" type="checkbox" name="timeframes[{{ loop.index0 }}][days][monday]" value="1" 
                                     {% if 1 in timeframe.days %}checked{% endif %}>
                              <label class="form-check-label">Monday</label>
                            </div>
                            <div class="form-check">
                              <input class="form-check-input" type="checkbox" name="timeframes[{{ loop.index0 }}][days][tuesday]" value="2"
                                     {% if 2 in timeframe.days %}checked{% endif %}>
                              <label class="form-check-label">Tuesday</label>
                            </div>
                            <div class="form-check">
                              <input class="form-check-input" type="checkbox" name="timeframes[{{ loop.index0 }}][days][wednesday]" value="3"
                                     {% if 3 in timeframe.days %}checked{% endif %}>
                              <label class="form-check-label">Wednesday</label>
                            </div>
                            <div class="form-check">
                              <input class="form-check-input" type="checkbox" name="timeframes[{{ loop.index0 }}][days][thursday]" value="4"
                                     {% if 4 in timeframe.days %}checked{% endif %}>
                              <label class="form-check-label">Thursday</label>
                            </div>
                            <div class="form-check">
                              <input class="form-check-input" type="checkbox" name="timeframes[{{ loop.index0 }}][days][friday]" value="5"
                                     {% if 5 in timeframe.days %}checked{% endif %}>
                              <label class="form-check-label">Friday</label>
                            </div>
                            <div class="form-check">
                              <input class="form-check-input" type="checkbox" name="timeframes[{{ loop.index0 }}][days][saturday]" value="6"
                                     {% if 6 in timeframe.days %}checked{% endif %}>
                              <label class="form-check-label">Saturday</label>
                            </div>
                            <div class="form-check">
                              <input class="form-check-input" type="checkbox" name="timeframes[{{ loop.index0 }}][days][sunday]" value="0"
                                     {% if 0 in timeframe.days %}checked{% endif %}>
                              <label class="form-check-label">Sunday</label>
                            </div>
                          </div>
                          <div class="col-md-6">
                            <div class="form-group">
                              <label for="start_time_{{ loop.index0 }}">Start Time</label>
                              <input type="time" class="form-control" id="start_time_{{ loop.index0 }}" 
                                     name="timeframes[{{ loop.index0 }}][start_time]" 
                                     value="{{ timeframe.start_time }}" required>
                            </div>
                            <div class="form-group">
                              <label for="end_time_{{ loop.index0 }}">End Time</label>
                              <input type="time" class="form-control" id="end_time_{{ loop.index0 }}" 
                                     name="timeframes[{{ loop.index0 }}][end_time]" 
                                     value="{{ timeframe.end_time }}" required>
                            </div>
                          </div>
                        </div>
                      </div>
                    </div>
                  {% endfor %}
                {% endif %}
              </div>
              
              <button type="button" class="btn btn-primary" id="addTimeframe">
                <i class="fas fa-plus"></i> Add Timeframe
              </button>
            </div>
            
            <hr>

            <!-- Mappings Section -->
            <div class="form-group">
              <h5>Mappings</h5>
              <p class="text-muted">Define which users, groups, credentials, doors, and zones this schedule applies to. Multiple mappings are supported. A user should only have access to doors checked here (and all doors in the selected zones) for an active timeframe.</p>
              <div id="mappingsContainer">
                {% if schedule.mapping %}
                  {% for mapping in schedule.mapping %}
                    {% set mapping_index = loop.index0 %}
                    <div class="mapping-panel card mb-3" data-mapping-id="{{ mapping_index }}">
                      <div class="card-header d-flex justify-content-between align-items-center">
                        <div>
                          <label>Alias:</label>
                          <input type="text" class="form-control d-inline-block w-auto" name="mappings[{{ mapping_index }}][alias]" value="{{ mapping.alias }}" required>
                        </div>
                        <button type="button" class="btn btn-sm btn-danger remove-mapping"><i class="fas fa-trash"></i> Remove</button>
                      </div>
                      <div class="card-body">
                        <div class="row">
                          <div class="col-md-6">
                            <label>Users</label>
                            <div class="form-group">
                              {% for user in users %}
                                <div class="form-check">
                                  <input class="form-check-input" type="checkbox" name="mappings[{{ mapping_index }}][users][]" value="{{ user.id }}" id="mapping-{{ mapping_index }}-user-{{ user.id }}" {% if user.id in mapping.users %}checked{% endif %}>
                                  <label class="form-check-label" for="mapping-{{ mapping_index }}-user-{{ user.id }}">
                                    {{ user.username }} ({{ user.firstname }} {{ user.lastname }})
                                  </label>
                                </div>
                              {% endfor %}
                            </div>
                          </div>
                          <div class="col-md-6">
                            <label>Groups</label>
                            <div class="form-group">
                              {% for group in groups %}
                                <div class="form-check">
                                  <input class="form-check-input" type="checkbox" name="mappings[{{ mapping_index }}][groups][]" value="{{ group.id }}" id="mapping-{{ mapping_index }}-group-{{ group.id }}" {% if group.id in mapping.groups %}checked{% endif %}>
                                  <label class="form-check-label" for="mapping-{{ mapping_index }}-group-{{ group.id }}">
                                    {{ group.name }}
                                  </label>
                                </div>
                              {% endfor %}
                            </div>
                          </div>
                        </div>
                        <div class="row mt-3">
                          <div class="col-md-6">
                            <label>Credentials</label>
                            <div class="form-group">
                              {% for cred in credentials %}
                                <div class="form-check">
                                  <input class="form-check-input" type="checkbox" name="mappings[{{ mapping_index }}][credentials][]" value="{{ cred.id }}" id="mapping-{{ mapping_index }}-cred-{{ cred.id }}" {% if cred.id in mapping.credentials %}checked{% endif %}>
                                  <label class="form-check-label" for="mapping-{{ mapping_index }}-cred-{{ cred.id }}">
                                    {{ cred.alias }} ({{ cred.type }})
                                  </label>
                                </div>
                              {% endfor %}
                            </div>
                          </div>
                           <div class="col-md-6">
                            <label>Doors</label>
                            <div class="form-group">
                              {% for door in doors %}
                                <div class="form-check">
                                  <input class="form-check-input" type="checkbox" name="mappings[{{ mapping_index }}][doors][]" value="{{ door.id }}" id="mapping-{{ mapping_index }}-door-{{ door.id }}" {% if door.id in mapping.doors %}checked{% endif %}>
                                  <label class="form-check-label" for="mapping-{{ mapping_index }}-door-{{ door.id }}">
                                    {{ door.attributes.alias or ('Door ' ~ door.id) }}
                                  </label>
                                </div>
                              {% endfor %}
                            </div>
                          </div>
                           <div class="col-md-6">
                             <label>Zones</label>
                             <div class="form-group">
                               {% set mapping_zones = mapping.zones or [] %}
                               {% for zone in zones %}
                                 <div class="form-check">
                                   <input class="form-check-input" type="checkbox" name="mappings[{{ mapping_index }}][zones][]" value="{{ zone.id }}" id="mapping-{{ mapping_index }}-zone-{{ zone.id }}" {% if zone.id in mapping_zones %}checked{% endif %}>
                                   <label class="form-check-label" for="mapping-{{ mapping_index }}-zone-{{ zone.id }}">
                                     {{ zone.attributes.alias or ('Zone ' ~ zone.id) }}
                                   </label>
                                 </div>
                               {% endfor %}
                             </div>
                           </div>
                        </div>
                      </div>
                    </div>
                  {% endfor %}
                {% endif %}
              </div>
              <button type="button" class="btn btn-primary" id="addMapping">
                <i class="fas fa-plus"></i> Add Mapping
              </button>
            </div>
            
            <hr>
            
            <div class="form-group">
              <button type="submit" class="btn btn-primary">
                <i class="fas fa-save"></i> Update Schedule
              </button>
              <a href="{{ url_for('schedules.schedule_view', schedule_id=schedule.id) }}" class="btn btn-secondary">
                <i class="fas fa-times"></i> Cancel
              </a>
            </div>
          </form>
        </div>
      </div>
    </div>
  </div>
</div>

<script>
let timeframeCounter = {{ schedule.timeframes|length }};

document.getElementById('addTimeframe').addEventListener('click', function() {
  const container = document.getElementById('timeframesContainer');
  const newTimeframe = document.createElement('div');
  newTimeframe.className = 'timeframe-panel card mb-3';
  newTimeframe.setAttribute('data-timeframe-id', timeframeCounter);
  
  newTimeframe.innerHTML = `
    <div class="card-header">
      <h6 class="mb-0">Timeframe ${timeframeCounter + 1}</h6>
      <button type="button" class="btn btn-sm btn-danger float-right remove-timeframe">
        <i class="fas fa-trash"></i> Remove
      </button>
    </div>
    <div class="card-body">
      <div class="row">
        <div class="col-md-6">
          <label>Days of Week</label>
          <div class="form-check">
            <input class="form-check-input" type="checkbox" name="timeframes[${timeframeCounter}][days][monday]" value="1">
            <label class="form-check-label">Monday</label>
          </div>
          <div class="form-check">
            <input class="form-check-input" type="checkbox" name="timeframes[${timeframeCounter}][days][tuesday]" value="2">
            <label class="form-check-label">Tuesday</label>
          </div>
          <div class="form-check">
            <input class="form-check-input" type="checkbox" name="timeframes[${timeframeCounter}][days][wednesday]" value="3">
            <label class="form-check-label">Wednesday</label>
          </div>
          <div class="form-check">
            <input class="form-check-input" type="checkbox" name="timeframes[${timeframeCounter}][days][thursday]" value="4">
            <label class="form-check-label">Thursday</label>
          </div>
          <div class="form-check">
            <input class="form-check-input" type="checkbox" name="timeframes[${timeframeCounter}][days][friday]" value="5">
            <label class="form-check-label">Friday</label>
          </div>
          <div class="form-check">
            <input class="form-check-input" type="checkbox" name="timeframes[${timeframeCounter}][days][saturday]" value="6">
            <label class="form-check-label">Saturday</label>
          </div>
          <div class="form-check">
            <input class="form-check-input" type="checkbox" name="timeframes[${timeframeCounter}][days][sunday]" value="0">
            <label class="form-check-label">Sunday</label>
          </div>
        </div>
        <div class="col-md-6">
          <div class="form-group">
            <label for="start_time_${timeframeCounter}">Start Time</label>
            <input type="time" class="form-control" id="start_time_${timeframeCounter}" 
                   name="timeframes[${timeframeCounter}][start_time]" required>
          </div>
          <div class="form-group">
            <label for="end_time_${timeframeCounter}">End Time</label>
            <input type="time" class="form-control" id="end_time_${timeframeCounter}" 
                   name="timeframes[${timeframeCounter}][end_time]" required>
          </div>
        </div>
      </div>
    </div>
  `;
  
  container.appendChild(newTimeframe);
  timeframeCounter++;
});

// Handle remove timeframe buttons
document.addEventListener('click', function(e) {
  if (e.target.classList.contains('remove-timeframe') || e.target.closest('.remove-timeframe')) {
    const timeframePanel = e.target.closest('.timeframe-panel');
    if (timeframePanel) {
      timeframePanel.remove();
    }
  }
});

let users = {{ users|tojson|safe }};
let groups = {{ groups|tojson|safe }};
let credentials = {{ credentials|tojson|safe }};
let doors = {{ doors|tojson|safe }};
let zones = {{ zones|tojson|safe }};

let mappingCounter = {{ schedule.mapping|length if schedule.mapping else 0 }};

document.getElementById('addMapping').addEventListener('click', function() {
  const container = document.getElementById('mappingsContainer');
  const newMapping = document.createElement('div');
  newMapping.className = 'mapping-panel card mb-3';
  newMapping.setAttribute('data-mapping-id', mappingCounter);
  let usersHtml = users.map(user => `
    <div class="form-check">
      <input class="form-check-input" type="checkbox" name="mappings[${mappingCounter}][users][]" value="${user.id}" id="mapping-${mappingCounter}-user-${user.id}">
      <label class="form-check-label" for="mapping-${mappingCounter}-user-${user.id}">${user.username} (${user.firstname} ${user.lastname})</label>
    </div>
  `).join('');
  let groupsHtml = groups.map(group => `
    <div class="form-check">
      <input class="form-check-input" type="checkbox" name="mappings[${mappingCounter}][groups][]" value="${group.id}" id="mapping-${mappingCounter}-group-${group.id}">
      <label class="form-check-label" for="mapping-${mappingCounter}-group-${group.id}">${group.name}</label>
    </div>
  `).join('');
  let credentialsHtml = credentials.map(cred => `
    <div class="form-check">
      <input class="form-check-input" type="checkbox" name="mappings[${mappingCounter}][credentials][]" value="${cred.id}" id="mapping-${mappingCounter}-cred-${cred.id}">
      <label class="form-check-label" for="mapping-${mappingCounter}-cred-${cred.id}">${cred.alias} (${cred.type})</label>
    </div>
  `).join('');
  let doorsHtml = doors.map(door => `
    <div class="form-check">
      <input class="form-check-input" type="checkbox" name="mappings[${mappingCounter}][doors][]" value="${door.id}" id="mapping-${mappingCounter}-door-${door.id}">
      <label class="form-check-label" for="mapping-${mappingCounter}-door-${door.id}">${(door.attributes && door.attributes.alias) ? door.attributes.alias : ('Door ' + door.id)}</label>
    </div>
  `).join('');
  let zonesHtml = zones.map(zone => `
    <div class="form-check">
      <input class="form-check-input" type="checkbox" name="mappings[${mappingCounter}][zones][]" value="${zone.id}" id="mapping-${mappingCounter}-zone-${zone.id}">
      <label class="form-check-label" for="mapping-${mappingCounter}-zone-${zone.id}">${(zone.attributes && zone.attributes.alias) ? zone.attributes.alias : ('Zone ' + zone.id)}</label>
    </div>
  `).join('');
  newMapping.innerHTML = `
    <div class="card-header d-flex justify-content-between align-items-center">
      <div>
        <label>Alias:</label>
        <input type="text" class="form-control d-inline-block w-auto" name="mappings[${mappingCounter}][alias]" required>
      </div>
      <button type="button" class="btn btn-sm btn-danger remove-mapping"><i class="fas fa-trash"></i> Remove</button>
    </div>
    <div class="card-body">
      <div class="row">
        <div class="col-md-6">
          <label>Users</label>
          <div class="form-group">${usersHtml}</div>
        </div>
        <div class="col-md-6">
          <label>Groups</label>
          <div class="form-group">${groupsHtml}</div>
        </div>
      </div>
      <div class="row mt-3">
        <div class="col-md-6">
          <label>Credentials</label>
          <div class="form-group">${credentialsHtml}</div>
        </div>
        <div class="col-md-6">
          <label>Doors</label>
          <div class="form-group">${doorsHtml}</div>
        </div>
        <div class="col-md-6">
          <label>Zones</label>
          <div class="form-group">${zonesHtml}</div>
        </div>
      </div>
    </div>
  `;
  container.appendChild(newMapping);
  mappingCounter++;
});

document.addEventListener('click', function(e) {
  if (e.target.classList.contains('remove-mapping') || e.target.closest('.remove-mapping')) {
    const mappingPanel = e.target.closest('.mapping-panel');
    if (mappingPanel) {
      mappingPanel.remove();
    }
  }
});
</script>
{% endblock %} 
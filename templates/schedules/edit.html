{% extends "base.html" %}

{% block content %}
<div class="container-fluid">
  <div class="row">
    <div class="col-12">
      <div class="card">
        <div class="card-header">
          <h3 class="card-title">Edit Schedule: {{ schedule.name }}</h3>
        </div>
        <div class="card-body">
          <form method="POST" id="scheduleForm">
            <div class="form-group">
              <label for="name">Schedule Name *</label>
              <input type="text" class="form-control" id="name" name="name" 
                     value="{{ schedule.name }}"
                     placeholder="Enter schedule name (3-50 characters, no spaces)" 
                     pattern="[a-zA-Z0-9_.-]+" title="Only letters, numbers, underscores, hyphens, and periods are allowed"
                     required minlength="3" maxlength="50">
              <small class="form-text text-muted">
                Schedule name must be between 3 and 50 characters long. Only letters, numbers, underscores (_), hyphens (-), and periods (.) are allowed. No spaces.
              </small>
            </div>
            
            <div class="form-group">
              <label for="description">Description</label>
              <textarea class="form-control" id="description" name="description" 
                        rows="3" placeholder="Enter schedule description (optional)">{{ schedule.description or '' }}</textarea>
              <small class="form-text text-muted">
                Optional description for this schedule.
              </small>
            </div>
            
            <hr>
            
            <!-- Timeframes Section -->
            <div class="form-group">
              <h5>Timeframes</h5>
              <p class="text-muted">Define when this schedule is active. Each timeframe can be enabled for specific days of the week.</p>
              
              <div id="timeframesContainer">
                {% if schedule.timeframes %}
                  {% for timeframe in schedule.timeframes %}
                    <div class="timeframe-panel card mb-3" data-timeframe-id="{{ loop.index0 }}">
                      <div class="card-header">
                        <h6 class="mb-0">Timeframe {{ loop.index }}</h6>
                        <button type="button" class="btn btn-sm btn-danger float-right remove-timeframe">
                          <i class="fas fa-trash"></i> Remove
                        </button>
                      </div>
                      <div class="card-body">
                        <div class="row">
                          <div class="col-md-6">
                            <label>Days of Week</label>
                            <div class="form-check">
                              <input class="form-check-input" type="checkbox" name="timeframes[{{ loop.index0 }}][days][monday]" value="1" 
                                     {% if 1 in timeframe.days %}checked{% endif %}>
                              <label class="form-check-label">Monday</label>
                            </div>
                            <div class="form-check">
                              <input class="form-check-input" type="checkbox" name="timeframes[{{ loop.index0 }}][days][tuesday]" value="2"
                                     {% if 2 in timeframe.days %}checked{% endif %}>
                              <label class="form-check-label">Tuesday</label>
                            </div>
                            <div class="form-check">
                              <input class="form-check-input" type="checkbox" name="timeframes[{{ loop.index0 }}][days][wednesday]" value="3"
                                     {% if 3 in timeframe.days %}checked{% endif %}>
                              <label class="form-check-label">Wednesday</label>
                            </div>
                            <div class="form-check">
                              <input class="form-check-input" type="checkbox" name="timeframes[{{ loop.index0 }}][days][thursday]" value="4"
                                     {% if 4 in timeframe.days %}checked{% endif %}>
                              <label class="form-check-label">Thursday</label>
                            </div>
                            <div class="form-check">
                              <input class="form-check-input" type="checkbox" name="timeframes[{{ loop.index0 }}][days][friday]" value="5"
                                     {% if 5 in timeframe.days %}checked{% endif %}>
                              <label class="form-check-label">Friday</label>
                            </div>
                            <div class="form-check">
                              <input class="form-check-input" type="checkbox" name="timeframes[{{ loop.index0 }}][days][saturday]" value="6"
                                     {% if 6 in timeframe.days %}checked{% endif %}>
                              <label class="form-check-label">Saturday</label>
                            </div>
                            <div class="form-check">
                              <input class="form-check-input" type="checkbox" name="timeframes[{{ loop.index0 }}][days][sunday]" value="0"
                                     {% if 0 in timeframe.days %}checked{% endif %}>
                              <label class="form-check-label">Sunday</label>
                            </div>
                          </div>
                          <div class="col-md-6">
                            <div class="form-group">
                              <label for="start_time_{{ loop.index0 }}">Start Time</label>
                              <input type="time" class="form-control" id="start_time_{{ loop.index0 }}" 
                                     name="timeframes[{{ loop.index0 }}][start_time]" 
                                     value="{{ timeframe.start_time }}" required>
                            </div>
                            <div class="form-group">
                              <label for="end_time_{{ loop.index0 }}">End Time</label>
                              <input type="time" class="form-control" id="end_time_{{ loop.index0 }}" 
                                     name="timeframes[{{ loop.index0 }}][end_time]" 
                                     value="{{ timeframe.end_time }}" required>
                            </div>
                          </div>
                        </div>
                      </div>
                    </div>
                  {% endfor %}
                {% endif %}
              </div>
              
              <button type="button" class="btn btn-primary" id="addTimeframe">
                <i class="fas fa-plus"></i> Add Timeframe
              </button>
            </div>
            
            <hr>

            <!-- Mappings Section -->
            <div class="form-group">
              <h5>Mappings</h5>
              <p class="text-muted">Define which users, groups, credentials, doors, and zones this schedule applies to. Multiple mappings are supported. A user should only have access to doors checked here (and all doors in the selected zones) for an active timeframe.</p>
              <div id="mappingsContainer">
                {% if schedule.mapping %}
                  {% for mapping in schedule.mapping %}
                    {% set mapping_index = loop.index0 %}
                    <div class="mapping-panel card mb-3" data-mapping-id="{{ mapping_index }}">
                      <div class="card-header d-flex justify-content-between align-items-center">
                        <div>
                          <label>Alias:</label>
                          <input type="text" class="form-control d-inline-block w-auto" name="mappings[{{ mapping_index }}][alias]" value="{{ mapping.alias }}" required>
                        </div>
                        <button type="button" class="btn btn-sm btn-danger remove-mapping"><i class="fas fa-trash"></i> Remove</button>
                      </div>
                      <div class="card-body">
                        <div class="row">
                          <div class="col-md-6">
                            <label>Users</label>
                            <div class="form-group">
                              {% for user in users %}
                                <div class="form-check">
                                  <input class="form-check-input" type="checkbox" name="mappings[{{ mapping_index }}][users][]" value="{{ user.id }}" id="mapping-{{ mapping_index }}-user-{{ user.id }}" {% if user.id in mapping.users %}checked{% endif %}>
                                  <label class="form-check-label" for="mapping-{{ mapping_index }}-user-{{ user.id }}">
                                    {{ user.username }} ({{ user.firstname }} {{ user.lastname }})
                                  </label>
                                </div>
                              {% endfor %}
                            </div>
                          </div>
                          <div class="col-md-6">
                            <label>Groups</label>
                            <div class="form-group">
                              {% for group in groups %}
                                <div class="form-check">
                                  <input class="form-check-input" type="checkbox" name="mappings[{{ mapping_index }}][groups][]" value="{{ group.id }}" id="mapping-{{ mapping_index }}-group-{{ group.id }}" {% if group.id in mapping.groups %}checked{% endif %}>
                                  <label class="form-check-label" for="mapping-{{ mapping_index }}-group-{{ group.id }}">
                                    {{ group.name }}
                                  </label>
                                </div>
                              {% endfor %}
                            </div>
                          </div>
                        </div>
                        <div class="row mt-3">
                          <div class="col-md-6">
                            <label>Credentials</label>
                            <div class="form-group">
                              {% for cred in credentials %}
                                <div class="form-check">
                                  <input class="form-check-input" type="checkbox" name="mappings[{{ mapping_index }}][credentials][]" value="{{ cred.id }}" id="mapping-{{ mapping_index }}-cred-{{ cred.id }}" {% if cred.id in mapping.credentials %}checked{% endif %}>
                                  <label class="form-check-label" for="mapping-{{ mapping_index }}-cred-{{ cred.id }}">
                                    {{ cred.alias }} ({{ cred.type }})
                                  </label>
                                </div>
                              {% endfor %}
                            </div>
                          </div>
                           <div class="col-md-6">
                            <label>Doors</label>
                            <div class="form-group">
                              {% for door in doors %}
                                <div class="form-check">
                                  <input class="form-check-input" type="checkbox" name="mappings[{{ mapping_index }}][doors][]" value="{{ door.id }}" id="mapping-{{ mapping_index }}-door-{{ door.id }}" {% if door.id in mapping.doors %}checked{% endif %}>
                                  <label class="form-check-label" for="mapping-{{ mapping_index }}-door-{{ door.id }}">
                                    {{ door.attributes.alias or ('Door ' ~ door.id) }}
                                  </label>
                                </div>
                              {% endfor %}
                            </div>
                          </div>
                           <div class="col-md-6">
                             <label>Zones</label>
                             <div class="form-group">
                               {% set mapping_zones = mapping.zones or [] %}
                               {% for zone in zones %}
                                 <div class="form-check">
                                   <input class="form-check-input" type="checkbox" name="mappings[{{ mapping_index }}][zones][]" value="{{ zone.id }}" id="mapping-{{ mapping_index }}-zone-{{ zone.id }}" {% if zone.id in mapping_zones %}checked{% endif %}>
                                   <label class="form-check-label" for="mapping-{{ mapping_index }}-zone-{{ zone.id }}">
                                     {{ zone.attributes.alias or ('Zone ' ~ zone.id) }}
                                   </label>
                                 </div>
                               {% endfor %}
                             </div>
                           </div>
                        </div>
                      </div>
                    </div>
                  {% endfor %}
                {% endif %}
              </div>
              <button type="button" class="btn btn-primary" id="addMapping">
                <i class="fas fa-plus"></i> Add Mapping
              </button>
            </div>
            
            <hr>
            
            <div class="form-group">
              <button type="submit" class="btn btn-primary">
                <i class="fas fa-save"></i> Update Schedule
              </button>
              <a href="{{ url_for('schedules.schedule_view', schedule_id=schedule.id) }}" class="btn btn-secondary">
                <i class="fas fa-times"></i> Cancel
              </a>
            </div>
          </form>
        </div>
      </div>
    </div>
  </div>
</div>

<script>
let timeframeCounter = {{ schedule.timeframes|length }};

document.getElementById('addTimeframe').addEventListener('click', function() {
  const container = document.getElementById('timeframesContainer');
  const newTimeframe = document.createElement('div');
  newTimeframe.className = 'timeframe-panel card mb-3';
  newTimeframe.setAttribute('data-timeframe-id', timeframeCounter);
  
  newTimeframe.innerHTML = `
    <div class="card-header">
      <h6 class="mb-0">Timeframe ${timeframeCounter + 1}</h6>
      <button type="button" class="btn btn-sm btn-danger float-right remove-timeframe">
        <i class="fas fa-trash"></i> Remove
      </button>
    </div>
    <div class="card-body">
      <div class="row">
        <div class="col-md-6">
          <label>Days of Week</label>
          <div class="form-check">
            <input class="form-check-input" type="checkbox" name="timeframes[${timeframeCounter}][days][monday]" value="1">
            <label class="form-check-label">Monday</label>
          </div>
          <div class="form-check">
            <input class="form-check-input" type="checkbox" name="timeframes[${timeframeCounter}][days][tuesday]" value="2">
            <label class="form-check-label">Tuesday</label>
          </div>
          <div class="form-check">
            <input class="form-check-input" type="checkbox" name="timeframes[${timeframeCounter}][days][wednesday]" value="3">
            <label class="form-check-label">Wednesday</label>
          </div>
          <div class="form-check">
            <input class="form-check-input" type="checkbox" name="timeframes[${timeframeCounter}][days][thursday]" value="4">
            <label class="form-check-label">Thursday</label>
          </div>
          <div class="form-check">
            <input class="form-check-input" type="checkbox" name="timeframes[${timeframeCounter}][days][friday]" value="5">
            <label class="form-check-label">Friday</label>
          </div>
          <div class="form-check">
            <input class="form-check-input" type="checkbox" name="timeframes[${timeframeCounter}][days][saturday]" value="6">
            <label class="form-check-label">Saturday</label>
          </div>
          <div class="form-check">
            <input class="form-check-input" type="checkbox" name="timeframes[${timeframeCounter}][days][sunday]" value="0">
            <label class="form-check-label">Sunday</label>
          </div>
        </div>
        <div class="col-md-6">
          <div class="form-group">
            <label for="start_time_${timeframeCounter}">Start Time</label>
            <input type="time" class="form-control" id="start_time_${timeframeCounter}" 
                   name="timeframes[${timeframeCounter}][start_time]" required>
          </div>
          <div class="form-group">
            <label for="end_time_${timeframeCounter}">End Time</label>
            <input type="time" class="form-control" id="end_time_${timeframeCounter}" 
                   name="timeframes[${timeframeCounter}][end_time]" required>
          </div>
        </div>
      </div>
    </div>
  `;
  
  container.appendChild(newTimeframe);
  timeframeCounter++;
});

// Handle remove timeframe buttons
document.addEventListener('click', function(e) {
  if (e.target.classList.contains('remove-timeframe') || e.target.closest('.remove-timeframe')) {
    const timeframePanel = e.target.closest('.timeframe-panel');
    if (timeframePanel) {
      timeframePanel.remove();
    }
  }
});

let users = {{ users|tojson|safe }};
let groups = {{ groups|tojson|safe }};
let credentials = {{ credentials|tojson|safe }};
let doors = {{ doors|tojson|safe }};
let zones = {{ zones|tojson|safe }};

let mappingCounter = {{ schedule.mapping|length if schedule.mapping else 0 }};

document.getElementById('addMapping').addEventListener('click', function() {
  const container = document.getElementById('mappingsContainer');
  const newMapping = document.createElement('div');
  newMapping.className = 'mapping-panel card mb-3';
  newMapping.setAttribute('data-mapping-id', mappingCounter);
  let usersHtml = users.map(user => `
    <div class="form-check">
      <input class="form-check-input" type="checkbox" name="mappings[${mappingCounter}][users][]" value="${user.id}" id="mapping-${mappingCounter}-user-${user.id}">
      <label class="form-check-label" for="mapping-${mappingCounter}-user-${user.id}">${user.username} (${user.firstname} ${user.lastname})</label>
    </div>
  `).join('');
  let groupsHtml = groups.map(group => `
    <div class="form-check">
      <input class="form-check-input" type="checkbox" name="mappings[${mappingCounter}][groups][]" value="${group.id}" id="mapping-${mappingCounter}-group-${group.id}">
      <label class="form-check-label" for="mapping-${mappingCounter}-group-${group.id}">${group.name}</label>
    </div>
  `).join('');
  let credentialsHtml = credentials.map(cred => `
    <div class="form-check">
      <input class="form-check-input" type="checkbox" name="mappings[${mappingCounter}][credentials][]" value="${cred.id}" id="mapping-${mappingCounter}-cred-${cred.id}">
      <label class="form-check-label" for="mapping-${mappingCounter}-cred-${cred.id}">${cred.alias} (${cred.type})</label>
    </div>
  `).join('');
  let doorsHtml = doors.map(door => `
    <div class="form-check">
      <input class="form-check-input" type="checkbox" name="mappings[${mappingCounter}][doors][]" value="${door.id}" id="mapping-${mappingCounter}-door-${door.id}">
      <label class="form-check-label" for="mapping-${mappingCounter}-door-${door.id}">${(door.attributes && door.attributes.alias) ? door.attributes.alias : ('Door ' + door.id)}</label>
    </div>
  `).join('');
  let zonesHtml = zones.map(zone => `
    <div class="form-check">
      <input class="form-check-input" type="checkbox" name="mappings[${mappingCounter}][zones][]" value="${zone.id}" id="mapping-${mappingCounter}-zone-${zone.id}">
      <label class="form-check-label" for="mapping-${mappingCounter}-zone-${zone.id}">${(zone.attributes && zone.attributes.alias) ? zone.attributes.alias : ('Zone ' + zone.id)}</label>
    </div>
  `).join('');
  newMapping.innerHTML = `
    <div class="card-header d-flex justify-content-between align-items-center">
      <div>
        <label>Alias:</label>
        <input type="text" class="form-control d-inline-block w-auto" name="mappings[${mappingCounter}][alias]" required>
      </div>
      <button type="button" class="btn btn-sm btn-danger remove-mapping"><i class="fas fa-trash"></i> Remove</button>
    </div>
    <div class="card-body">
      <div class="row">
        <div class="col-md-6">
          <label>Users</label>
          <div class="form-group">${usersHtml}</div>
        </div>
        <div class="col-md-6">
          <label>Groups</label>
          <div class="form-group">${groupsHtml}</div>
        </div>
      </div>
      <div class="row mt-3">
        <div class="col-md-6">
          <label>Credentials</label>
          <div class="form-group">${credentialsHtml}</div>
        </div>
        <div class="col-md-6">
          <label>Doors</label>
          <div class="form-group">${doorsHtml}</div>
        </div>
        <div class="col-md-6">
          <label>Zones</label>
          <div class="form-group">${zonesHtml}</div>
        </div>
      </div>
    </div>
  `;
  container.appendChild(newMapping);
  mappingCounter++;
});

document.addEventListener('click', function(e) {
  if (e.target.classList.contains('remove-mapping') || e.target.closest('.remove-mapping')) {
    const mappingPanel = e.target.closest('.mapping-panel');
    if (mappingPanel) {
      mappingPanel.remove();
    }
  }
});

// High-profile warning popup for door-only mappings
function showDoorOnlyWarning() {
  // Create a high-profile modal overlay
  const overlay = document.createElement('div');
  overlay.style.cssText = `
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(15, 17, 21, 0.95);
    z-index: 10000;
    display: flex;
    justify-content: center;
    align-items: center;
    animation: fadeIn 0.3s ease-in-out;
  `;
  
  // Create the warning modal
  const modal = document.createElement('div');
  modal.style.cssText = `
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: 12px;
    padding: 20px;
    max-width: 500px;
    width: 85%;
    box-shadow: 0 15px 40px rgba(0, 0, 0, 0.8);
    animation: slideIn 0.3s ease-out;
    text-align: center;
    color: var(--text);
  `;
  
  modal.innerHTML = `
    <div style="color: var(--danger); font-size: 32px; margin-bottom: 15px;">
      <i class="fas fa-exclamation-triangle"></i>
    </div>
    <h3 style="color: var(--danger); margin-bottom: 15px; font-weight: bold; font-size: 1.4rem;">
      <i class="fas fa-exclamation-triangle"></i> WARNING: Door-Only Schedule Mapping <i class="fas fa-exclamation-triangle"></i>
    </h3>
    <div style="background: linear-gradient(180deg, rgba(246, 197, 73, 0.15), rgba(246, 197, 73, 0.08)); border: 1px solid rgba(246, 197, 73, 0.35); border-radius: 8px; padding: 15px; margin: 15px 0; text-align: left;">
      <h5 style="color: var(--warning); margin-bottom: 12px; font-weight: 600; font-size: 1rem;">
        <i class="fas fa-exclamation-circle"></i> Potential Safety & Fire Hazard
      </h5>
      <p style="color: var(--text); margin-bottom: 10px; font-size: 14px; line-height: 1.5;">
        You are creating a schedule mapping that <strong style="color: var(--warning);">only has doors selected</strong> (or no access controls selected at all).
      </p>
      <p style="color: var(--text); margin-bottom: 15px; font-size: 14px; line-height: 1.5;">
        This will create an <strong style="color: var(--warning);">open/close schedule</strong> for those doors, which means the doors will be automatically opened during the schedule timeframe.
      </p>
      <div style="background: linear-gradient(180deg, rgba(239, 71, 111, 0.15), rgba(239, 71, 111, 0.08)); border: 1px solid rgba(239, 71, 111, 0.35); border-radius: 6px; padding: 12px; margin: 12px 0;">
        <h6 style="color: var(--danger); margin-bottom: 8px; font-weight: 600; font-size: 0.9rem;">
          <i class="fas fa-fire"></i> Critical Safety Concerns:
        </h6>
        <ul style="color: var(--text); margin: 0; padding-left: 16px; font-size: 13px; line-height: 1.4;">
          <li style="margin-bottom: 4px;"><strong>Door Strike Rating:</strong> Some doors are not rated to be open for extended periods of time. Extended opening could cause mechanical damage and potentially fire hazards.</li>
          <li style="margin-bottom: 4px;"><strong>Fire Safety:</strong> If the door is always open, and the strike is not rated for continuous operation, it could create a fire hazard.</li>
        </ul>
      </div>
      <div style="background: linear-gradient(180deg, rgba(86, 207, 225, 0.15), rgba(86, 207, 225, 0.08)); border: 1px solid rgba(86, 207, 225, 0.35); border-radius: 6px; padding: 12px; margin: 12px 0;">
        <h6 style="color: var(--info); margin-bottom: 8px; font-weight: 600; font-size: 0.9rem;">
          <i class="fas fa-lightbulb"></i> Recommendations:
        </h6>
        <ul style="color: var(--text); margin: 0; padding-left: 16px; font-size: 13px; line-height: 1.4;">
          <li style="margin-bottom: 4px;">Add users, groups, or credentials to the mapping to create proper access control instead of an open/close schedule.</li>
          <li style="margin-bottom: 4px;"><strong>Verify door strike rating:</strong> Ensure the door strike is rated for continuous on/off operation if you must proceed with this configuration.</li>
          <li style="margin-bottom: 4px;">Consider using time-based access control with proper user authentication rather than automatic door opening.</li>
        </ul>
      </div>
    </div>
    <div style="margin-top: 20px;">
      <button id="confirmDoorMapping" class="btn btn-danger" style="
        margin-right: 10px;
        font-weight: 600;
        padding: 8px 20px;
        border-radius: 6px;
        font-size: 14px;
      ">
        <i class="fas fa-exclamation-triangle"></i> Continue Anyway
      </button>
      <button id="cancelDoorMapping" class="btn btn-secondary" style="
        font-weight: 600;
        padding: 8px 20px;
        border-radius: 6px;
        font-size: 14px;
      ">
        <i class="fas fa-arrow-left"></i> Go Back
      </button>
    </div>
  `;
  
  overlay.appendChild(modal);
  document.body.appendChild(overlay);
  
  // Add CSS animations
  const style = document.createElement('style');
  style.textContent = `
    @keyframes fadeIn {
      from { opacity: 0; }
      to { opacity: 1; }
    }
    @keyframes slideIn {
      from { transform: translateY(-50px); opacity: 0; }
      to { transform: translateY(0); opacity: 1; }
    }
  `;
  document.head.appendChild(style);
  
  // Handle button clicks
  document.getElementById('confirmDoorMapping').addEventListener('click', function() {
    document.body.removeChild(overlay);
    document.head.removeChild(style);
    // Submit the form
    document.getElementById('scheduleForm').submit();
  });
  
  document.getElementById('cancelDoorMapping').addEventListener('click', function() {
    document.body.removeChild(overlay);
    document.head.removeChild(style);
    // Focus on the first mapping panel
    const firstMapping = document.querySelector('.mapping-panel');
    if (firstMapping) {
      firstMapping.scrollIntoView({ behavior: 'smooth', block: 'center' });
      firstMapping.style.border = '2px solid var(--warning)';
      setTimeout(() => {
        firstMapping.style.border = '';
      }, 3000);
    }
  });
  
  // Close on overlay click
  overlay.addEventListener('click', function(e) {
    if (e.target === overlay) {
      document.body.removeChild(overlay);
      document.head.removeChild(style);
    }
  });
}

// Check if a mapping has only doors selected (or nothing)
function hasOnlyDoorsOrNothing(mappingPanel) {
  const users = mappingPanel.querySelectorAll('input[name*="[users][]"]:checked');
  const groups = mappingPanel.querySelectorAll('input[name*="[groups][]"]:checked');
  const credentials = mappingPanel.querySelectorAll('input[name*="[credentials][]"]:checked');
  const doors = mappingPanel.querySelectorAll('input[name*="[doors][]"]:checked');
  const zones = mappingPanel.querySelectorAll('input[name*="[zones][]"]:checked');
  
  const hasUsers = users.length > 0;
  const hasGroups = groups.length > 0;
  const hasCredentials = credentials.length > 0;
  const hasDoors = doors.length > 0;
  const hasZones = zones.length > 0;
  
  // Check if only doors are selected (or nothing at all)
  return hasDoors && !hasUsers && !hasGroups && !hasCredentials && !hasZones;
}

// Real-time warning for door-only mappings
function updateMappingWarnings() {
  const mappingPanels = document.querySelectorAll('.mapping-panel');
  
  mappingPanels.forEach((panel, index) => {
    // Remove existing warning if any
    const existingWarning = panel.querySelector('.door-only-warning');
    if (existingWarning) {
      existingWarning.remove();
    }
    
    // Check if this mapping has only doors selected
    if (hasOnlyDoorsOrNothing(panel)) {
      const warning = document.createElement('div');
      warning.className = 'door-only-warning';
      warning.style.cssText = `
        background: linear-gradient(180deg, rgba(239, 71, 111, 0.15), rgba(239, 71, 111, 0.08));
        border: 1px solid rgba(239, 71, 111, 0.35);
        border-radius: 8px;
        padding: 15px;
        margin: 10px 0;
        color: var(--text);
        font-weight: 600;
        animation: pulse 2s infinite;
      `;
      warning.innerHTML = `
        <i class="fas fa-exclamation-triangle" style="color: var(--danger);"></i>
        <strong style="color: var(--danger);">WARNING:</strong> This mapping only has doors selected. 
        This will create an open/close schedule that may damage doors not rated for extended opening and create fire safety hazards.
        <br><small style="color: var(--text-muted);">Consider adding users, groups, or credentials for proper access control. Verify door strike rating for continuous operation.</small>
      `;
      
      // Insert after the card header
      const cardBody = panel.querySelector('.card-body');
      if (cardBody) {
        cardBody.insertBefore(warning, cardBody.firstChild);
      }
    }
  });
}

// Add pulse animation for warnings
const warningStyle = document.createElement('style');
warningStyle.textContent = `
  @keyframes pulse {
    0% { box-shadow: 0 0 0 0 rgba(239, 71, 111, 0.7); }
    70% { box-shadow: 0 0 0 10px rgba(239, 71, 111, 0); }
    100% { box-shadow: 0 0 0 0 rgba(239, 71, 111, 0); }
  }
`;
document.head.appendChild(warningStyle);

// Add event listeners to all checkboxes in mapping panels
function addMappingEventListeners() {
  const mappingPanels = document.querySelectorAll('.mapping-panel');
  mappingPanels.forEach(panel => {
    const checkboxes = panel.querySelectorAll('input[type="checkbox"]');
    checkboxes.forEach(checkbox => {
      checkbox.addEventListener('change', updateMappingWarnings);
    });
  });
}

// Initial setup
addMappingEventListeners();

// Update event listeners when new mappings are added
document.getElementById('addMapping').addEventListener('click', function() {
  // Wait for the new mapping to be added, then add event listeners
  setTimeout(() => {
    addMappingEventListeners();
    updateMappingWarnings();
  }, 100);
});

// Form submission handler
document.getElementById('scheduleForm').addEventListener('submit', function(e) {
  e.preventDefault();
  
  const mappingPanels = document.querySelectorAll('.mapping-panel');
  let hasDoorOnlyMapping = false;
  
  // Check each mapping panel
  for (let panel of mappingPanels) {
    if (hasOnlyDoorsOrNothing(panel)) {
      hasDoorOnlyMapping = true;
      break;
    }
  }
  
  if (hasDoorOnlyMapping) {
    showDoorOnlyWarning();
  } else {
    // No door-only mappings, submit normally
    this.submit();
  }
});
</script>
{% endblock %} 
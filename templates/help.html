{% extends "base.html" %}
{% block title %}Help - Leosac Web{% endblock %}
{% block page_title %}Help & Documentation{% endblock %}
{% block content %}
<div class="row">
  <div class="col-lg-12">
    <!-- System Overview -->
    <div class="card mb-4">
      <div class="card-header">
        <h5 class="mb-0"><i class="fas fa-info-circle me-2"></i>System Overview</h5>
      </div>
      <div class="card-body">
        <p class="lead">Leosac Web is an access control management system that allows you to control who can access which doors and when. This system manages users, credentials (RFID cards), groups, schedules, and door access permissions.</p>
        
        <div class="alert alert-info">
          <h6><i class="fas fa-lightbulb me-2"></i>How It Works</h6>
          <p class="mb-0">When someone presents an RFID card at a door, the system checks their credentials, user permissions, group memberships, and active schedules to determine if access should be granted or denied.</p>
        </div>
      </div>
    </div>

    <!-- Users Section -->
    <div class="card mb-4">
      <div class="card-header">
        <h5 class="mb-0"><i class="fas fa-users me-2"></i>Users</h5>
      </div>
      <div class="card-body">
        <p>Users are what are used to access the leosac web interface. Ideally, this should probably be kept to one user. The web interface has limitations and is not fully complete, so while you can create a user for each employee in the building and assign them to groups for easier management, I would recommend to have one or two admin accounts and leave it at that.</p>
        
        <div class="alert alert-warning">
          <h6><i class="fas fa-exclamation-triangle me-2"></i>Important Notes</h6>
          <ul class="mb-0">
            <li>A user cannot be deleted once it's created - an account must be disabled</li>
            <li>The reason for this is because deleting a user would delete all their audit events with the current code, and the feature was not fully implemented at the time of building</li>
            <li>Enabling a user allows them to be able to log in</li>
            <li>Disabling a user prevents them from being able to log in</li>
            <li>The email address does not matter for the account</li>
            <li>The user's role affects what the user can do in the web interface</li>
          </ul>
        </div>
        
        <h6>User Roles & Permissions</h6>
        <div class="table-responsive">
          <table class="table table-bordered">
            <thead class="table-dark">
              <tr>
                <th>Role</th>
                <th>Key Permissions</th>
              </tr>
            </thead>
            <tbody>
              <tr>
                <td><span class="badge badge-danger">ADMIN</span></td>
                <td>Full system access - can manage all users, groups, credentials, schedules, doors, zones, and system administration tasks including deleting users and restarting the server</td>
              </tr>
              <tr>
                <td><span class="badge badge-warning">SUPERVISOR</span></td>
                <td>Can manage users, groups, credentials, schedules, doors, access points, zones, and view system logs and audit trails</td>
              </tr>
              <tr>
                <td><span class="badge badge-info">MANAGER</span></td>
                <td>Can manage users, groups, credentials, schedules, doors, access points, zones, and view system logs and audit trails</td>
              </tr>
              <tr>
                <td><span class="badge badge-secondary">VIEWER</span></td>
                <td>Limited access - can view basic information, manage their own profile and credentials, search and read assigned schedules and doors</td>
              </tr>
            </tbody>
          </table>
        </div>
      </div>
    </div>

    <!-- Credentials Section -->
    <div class="card mb-4">
      <div class="card-header">
        <h5 class="mb-0"><i class="fas fa-id-badge me-2"></i>Credentials (RFID Cards)</h5>
      </div>
      <div class="card-body">
        <p>Credentials are RFID cards. These do not need to be tied to a user or owner and can be added into the system "ownerless". As I mentioned in Users, users are for logging into the system and do not need to be tied to credentials.</p>
        
        <div class="alert alert-info">
          <h6><i class="fas fa-info-circle me-2"></i>Important</h6>
          <p class="mb-0">Note that adding and enabling a credential does not give it access. You can have a card enabled but still not able to access any doors.</p>
        </div>

        <h6>How to Obtain RFID Hexadecimal Value</h6>
        <ol>
          <li>Log into leosac-1 (192.168.95.46)</li>
          <li>Run: <code>sudo journalctl -u leosac -f</code></li>
          <li>Swipe a card on any of the upstairs NOC readers that are in the system</li>
          <li>You should see data come in like so:
            <pre class="bg-dark text-light p-3 mt-2"><code>Sep 08 14:11:32 leosac-1 leosac[4608]: [2025-09-08 14:11:32.060] [console] [debug] [4628] timeout, buffer size = 26
Sep 08 14:11:32 leosac-1 leosac[4608]: [2025-09-08 14:11:32.060] [monitor_stdout] [info] F0: {S_NOC_FRONT_READER} ; F1: {0rr91} ; F2: {00:02:37:40} ; F3: {0000q} ;
Sep 08 14:11:32 leosac-1 leosac[4608]: [2025-09-08 14:11:32.069] [console] [info] [4629] Building a Credential object (RFIDCard): 00:02:37:40 with 26 significant bits. Source name = NOC_FRONT_READER</code></pre>
          </li>
          <li>Note the hexadecimal ID from the Credential object</li>
        </ol>

        <h6>How to Add/Edit an RFID Card</h6>
        <ol>
          <li>Go to the credentials tab in the leosac web gui</li>
          <li>Click Add RFID Card</li>
          <li>Give it an alias:
            <ul>
              <li>If you're not assigning it to a person yet, please name it with the card id on the physical card</li>
              <li>If you are assigning it to a person, assign their full name or their name + who they're associated with (Ex: IPS - Bob Dylan)</li>
            </ul>
          </li>
          <li>Set the hexadecimal card identifier</li>
          <li>Set the number of bits to 26 (or, the number of bits shown in the logs fetched above)</li>
          <li>Add the card id from the physical card in the notes - Please make sure to do this so the card can be identified without needing to swipe it (for when the alias gets changed to a person's name)</li>
          <li>Don't select a user (unless using users)</li>
          <li>You can choose to enable or leave disabled</li>
        </ol>
      </div>
    </div>

    <!-- Doors Section -->
    <div class="card mb-4">
      <div class="card-header">
        <h5 class="mb-0"><i class="fas fa-door-open me-2"></i>Doors</h5>
      </div>
      <div class="card-body">
        <p>Doors are objects that get added to the database for the backend configuration to authenticate against.</p>
        
        <div class="alert alert-info">
          <h6><i class="fas fa-info-circle me-2"></i>Configuration Match Required</h6>
          <p class="mb-0">Adding a door is very simple, all you need to do is match the Alias name with the name of the door in the kernel.xml configuration file the leosac server runs off of. You can find this file in /etc/leosac/kernel.xml of the leosac server you're working with.</p>
        </div>
      </div>
    </div>

    <!-- Groups Section -->
    <div class="card mb-4">
      <div class="card-header">
        <h5 class="mb-0"><i class="fas fa-layer-group me-2"></i>Groups</h5>
      </div>
      <div class="card-body">
        <p>Groups are tied to Users. Since I recommended not creating more than one or two admin users, this section isn't necessary and shouldn't be used.</p>
        
        <div class="alert alert-warning">
          <h6><i class="fas fa-exclamation-triangle me-2"></i>Recommendation</h6>
          <p class="mb-0">Groups make it a bit easier to create and manage schedules, but since users are tied to logins it's better to just use ownerless credentials in schedule mappings.</p>
        </div>
      </div>
    </div>

    <!-- Schedules Section -->
    <div class="card mb-4">
      <div class="card-header">
        <h5 class="mb-0"><i class="fas fa-calendar-alt me-2"></i>Schedules</h5>
      </div>
      <div class="card-body">
        <p>Schedules are where everything comes together. A schedule ties what doors can be accessed, by who, and when.</p>
        
        <p>Schedules can either apply to just doors (define when a door is open and when it's locked). Or, they can apply to when a user/group/credential can open the door while it's locked.</p>

        <h6>Schedule Components</h6>
        <div class="row">
          <div class="col-md-6">
            <h6><i class="fas fa-clock me-2"></i>Timeframes</h6>
            <p>Timeframes provide the window of time the schedule is active and when the doors can be opened. Any time that is not defined means the schedule will not work. For example, if a timeframe has M-F 8:30-5:30 checked, this schedule will only work for those times. Any time outside of that would be considered "closed" (the doors defined in the mapping won't be opened). You can have multiple timeframes per schedule.</p>
          </div>
          <div class="col-md-6">
            <h6><i class="fas fa-link me-2"></i>Mappings</h6>
            <p>Mappings define which users, groups, credentials, doors, and zones the schedule applies to. A mapping must always consist of at least one door (or zone) - if none are checked it should apply to all doors. From here you can assign credentials, users or groups that can access the door(s) defined. Access will be granted for the users defined for the door so long as the timeframe permits it.</p>
          </div>
        </div>

        <div class="alert alert-danger">
          <h6><i class="fas fa-exclamation-triangle me-2"></i>Door-Only Schedules Warning</h6>
          <p class="mb-0">Mappings also allow only adding doors - in this case, this will create an opened/closed schedule for that door where it doesn't need a card to open it. If setting this, please make sure the door strike is rated for continuous current, if it isn't it could ruin the door strike, or potentially cause a fire hazard since the coil can get quite hot.</p>
        </div>

        <h6>Example: Creating a 24/7 Schedule</h6>
        <ol>
          <li>Go to schedules</li>
          <li>Create Schedule</li>
          <li>Give it a name and description</li>
          <li>Add a timeframe:
            <ul>
              <li>Select all the days</li>
              <li>Set the start time to 12:00AM</li>
              <li>Set the end time to 11:59PM</li>
              <li>Note that leosac carries through end of the last minute - it does not stop at the start of the minute. This is important to note if you want to create door only schedules</li>
            </ul>
          </li>
          <li>Save/create</li>
          <li>Edit the schedule you just created</li>
          <li>Add Mapping:
            <ul>
              <li>Select the credentials/users/groups you want to have access</li>
              <li>Select the doors/zones you want to give access to</li>
              <li>Note again: Selecting only doors will make this a timed schedule</li>
            </ul>
          </li>
          <li>Save/Update</li>
        </ol>
        <p>With this schedule, all credentials/users/groups defined will have access to the selected doors 24/7. You could update the timeframe to say only M-F and those credentials/users/groups will no longer be able to get in on Saturday and Sunday.</p>
      </div>
    </div>

    <!-- Zones Section -->
    <div class="card mb-4">
      <div class="card-header">
        <h5 class="mb-0"><i class="fas fa-building me-2"></i>Zones</h5>
      </div>
      <div class="card-body">
        <p>Zones are a way to group doors. This simply makes managing schedule mappings easier making it so the user doesn't have to click on all the doors, but can instead define them in the zone and map to that.</p>
          </div>
        </div>

    <!-- Alarms Section -->
    <div class="card mb-4">
      <div class="card-header">
        <h5 class="mb-0"><i class="fas fa-bell me-2"></i>Alarms</h5>
      </div>
      <div class="card-body">
        <p>Alarms simply show the status of each leosac server, whether they can be reached or not. As long as one server is up, the web management interface will work in regards to updating the database.</p>
      </div>
    </div>

    <!-- Audit Section -->
    <div class="card mb-4">
      <div class="card-header">
        <h5 class="mb-0"><i class="fas fa-table me-2"></i>Audit Logs</h5>
      </div>
      <div class="card-body">
        <p>This section shows all audit events.</p>
      </div>
    </div>

    <!-- Complete Workflow Section -->
    <div class="card mb-4">
      <div class="card-header">
        <h5 class="mb-0"><i class="fas fa-project-diagram me-2"></i>Complete Access Control Workflow</h5>
      </div>
      <div class="card-body">
        <h6>Step-by-Step Process</h6>
        <div class="row">
          <div class="col-md-8">
            <ol>
              <li><strong>Create Users</strong> - Add people to the system (recommend 1-2 admin accounts only)</li>
              <li><strong>Create Credentials</strong> - Add RFID cards (can be ownerless)</li>
              <li><strong>Create Doors</strong> - Add physical access points (match kernel.xml names)</li>
              <li><strong>Create Schedules</strong> - Define when access is allowed</li>
              <li><strong>Create Schedule Mappings</strong> - Connect credentials to doors with time restrictions</li>
              <li><strong>Test Access</strong> - Verify the system works</li>
            </ol>
          </div>
          <div class="col-md-4">
            <div class="card bg-success text-white">
              <div class="card-body text-center">
                <i class="fas fa-check-circle fa-3x mb-2"></i>
                <h6>Success!</h6>
                <p class="mb-0">When all steps are complete, users can access doors according to their permissions and schedules.</p>
              </div>
            </div>
          </div>
        </div>

        <h6>What Happens When Someone Swipes a Card?</h6>
        <div class="alert alert-info">
          <ol>
            <li>The door reader scans the RFID card</li>
            <li>The system identifies the card ID</li>
            <li>The system looks up the card's owner (if assigned) or checks ownerless credentials</li>
            <li>The system checks all schedule mappings for that credential</li>
            <li>The system evaluates each mapping:
              <ul>
                <li>Is the mapping active?</li>
                <li>Does it apply to this door?</li>
                <li>Is the current time within the schedule?</li>
                <li>What's the priority level?</li>
              </ul>
            </li>
            <li>If any mapping allows access, the door unlocks</li>
            <li>The access attempt is logged in the audit trail</li>
          </ol>
        </div>
      </div>
    </div>

    <!-- Troubleshooting Section -->
    <div class="card mb-4">
      <div class="card-header">
        <h5 class="mb-0"><i class="fas fa-wrench me-2"></i>Troubleshooting Common Issues</h5>
      </div>
      <div class="card-body">
        <div class="row">
          <div class="col-md-6">
            <h6><i class="fas fa-times-circle text-danger me-2"></i>Access Denied Issues</h6>
            <ul>
              <li><strong>Card not recognized:</strong> Check Card ID matches exactly what's in the logs</li>
              <li><strong>Wrong time:</strong> Verify schedule is active and timeframe is correct</li>
              <li><strong>Wrong door:</strong> Check door assignments in mappings</li>
              <li><strong>Credential inactive:</strong> Check credential status</li>
              <li><strong>No mappings:</strong> Ensure schedule mappings exist for the credential</li>
            </ul>
          </div>
          <div class="col-md-6">
            <h6><i class="fas fa-question-circle text-warning me-2"></i>System Issues</h6>
            <ul>
              <li><strong>Can't log in:</strong> Check username/password</li>
              <li><strong>No permissions:</strong> Verify user role and permissions</li>
              <li><strong>Missing data:</strong> Check if required items exist</li>
              <li><strong>Connection errors:</strong> Verify system connectivity</li>
              <li><strong>Door not responding:</strong> Check kernel.xml configuration matches</li>
            </ul>
          </div>
        </div>

        <div class="alert alert-warning">
          <h6><i class="fas fa-exclamation-triangle me-2"></i>Need More Help?</h6>
          <p class="mb-0">Check the audit log to see exactly what happened during access attempts. The audit log shows all system activity and can help identify why access was granted or denied.</p>
        </div>
      </div>
    </div>

    <!-- Quick Reference Section -->
    <div class="card mb-4">
      <div class="card-header">
        <h5 class="mb-0"><i class="fas fa-bookmark me-2"></i>Quick Reference</h5>
      </div>
      <div class="card-body">
        <div class="row">
          <div class="col-md-6">
            <h6>Navigation Quick Links</h6>
            <ul class="list-unstyled">
              <li><i class="fas fa-user me-2"></i><a href="{{ url_for('users.users_list') }}">Users</a> - Manage people (recommend 1-2 admin accounts)</li>
              <li><i class="fas fa-id-badge me-2"></i><a href="{{ url_for('credentials.credentials_list') }}">Credentials</a> - Manage RFID cards</li>
              <li><i class="fas fa-calendar-alt me-2"></i><a href="{{ url_for('schedules.schedules_list') }}">Schedules</a> - Set time rules and mappings</li>
              <li><i class="fas fa-door-open me-2"></i><a href="{{ url_for('doors.doors_list') }}">Doors</a> - Access points (match kernel.xml)</li>
            </ul>
          </div>
          <div class="col-md-6">
            <h6>System Status</h6>
            <ul class="list-unstyled">
              <li><i class="fas fa-building me-2"></i><a href="{{ url_for('zones.zones_list') }}">Zones</a> - Group doors for easier management</li>
              <li><i class="fas fa-table me-2"></i><a href="{{ url_for('audit.auditlog') }}">Audit Log</a> - Activity history</li>
              <li><i class="fas fa-bell me-2"></i><a href="{{ url_for('alarms.alarms_page') }}">Alarms</a> - Server status</li>
            </ul>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>
{% endblock %}
{% extends "base.html" %}

{% block title %}Edit {{ credential.alias }} - Credential{% endblock %}
{% block page_title %}Edit {{ credential.alias }}{% endblock %}

{% block content %}
<div class="container-fluid">
  <div class="row">
    <div class="col-12">
      <div class="card">
        <div class="card-header d-flex justify-content-between align-items-center">
          <h3 class="mb-0">Edit Credential</h3>
          <div>
            <a href="{{ url_for('credentials.credential_view', credential_id=credential.id) }}" class="btn btn-secondary">
              <i class="fas fa-arrow-left"></i> Back to Details
            </a>
          </div>
        </div>
        <div class="card-body">
          <form method="POST" id="credential-edit-form">
            <div class="row">
              <div class="col-md-6">
                <fieldset>
                  <legend>Configuration</legend>
                  
                  <div class="form-group">
                    <label for="alias">Alias *</label>
                    <input type="text" class="form-control" id="alias" name="alias" 
                           placeholder="Credential alias" value="{{ credential.alias }}" required>
                    <small class="form-text text-muted">Enter a name for this credential (3-15 characters)</small>
                  </div>

                  {% if credential.type == 'rfid-card' %}
                  <div class="form-group">
                    <label for="card_id">Hexadecimal Card Identifier *</label>
                    <input type="text" class="form-control" id="card_id" name="card_id" 
                           placeholder="aa:bb:cc:11" value="{{ credential.card_id }}" required>
                    <small class="form-text text-muted">Enter the RFID card identifier in hex format (e.g., aa:bb:cc:11)</small>
                  </div>

                  <div class="form-group">
                    <label for="nb_bits">Number of Bits *</label>
                    <input type="number" class="form-control" id="nb_bits" name="nb_bits" 
                           placeholder="32" value="{{ credential.nb_bits }}" required>
                    <small class="form-text text-muted">Enter the number of bits for this card</small>
                  </div>
                  {% endif %}

                  <div class="form-group">
                    <label for="description">Notes</label>
                    <textarea class="form-control" id="description" name="description" rows="2" 
                              placeholder="Additional notes about this credential">{{ credential.description or '' }}</textarea>
                  </div>

                  <div class="form-group">
                    <label for="owner">Owner</label>
                    <select class="form-control" id="owner" name="owner">
                      <option value="">Select a user</option>
                      {% for user in users %}
                      <option value="{{ user.id }}" 
                              {{ 'selected' if credential.owner_id == user.id else '' }}>
                        {{ user.username }} ({{ user.firstname }} {{ user.lastname }})
                      </option>
                      {% endfor %}
                    </select>
                  </div>

                  <div class="form-group">
                    <label for="validity_enabled">
                      <input type="checkbox" id="validity_enabled" name="validity_enabled" 
                             {{ 'checked' if credential.validity_enabled else '' }}>
                      Enable Validity Period
                    </label>
                  </div>

                  <div class="form-group">
                    <label for="validity_start">Valid From</label>
                    <input type="datetime-local" class="form-control" id="validity_start" name="validity_start" 
                           value="{{ credential.validity_start or '' }}">
                  </div>

                  <div class="form-group">
                    <label for="validity_end">Valid Until</label>
                    <input type="datetime-local" class="form-control" id="validity_end" name="validity_end" 
                           value="{{ credential.validity_end or '' }}">
                  </div>

                  <div class="form-group">
                    <button type="submit" class="btn btn-success">Update Credential</button>
                    <a href="{{ url_for('credentials.credential_view', credential_id=credential.id) }}" class="btn btn-secondary">Cancel</a>
                  </div>
                </fieldset>
              </div>
            </div>
          </form>
        </div>
      </div>
    </div>
  </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
  const form = document.getElementById('credential-edit-form');
  const validityEnabledCheckbox = document.getElementById('validity_enabled');
  const validityStartInput = document.getElementById('validity_start');
  const validityEndInput = document.getElementById('validity_end');

  {% if credential.type == 'rfid-card' %}
  const cardIdInput = document.getElementById('card_id');
  const nbBitsInput = document.getElementById('nb_bits');

  // Card ID validation - server expects flexible hex format like aa:bb:cc:11 or aa:bb:cc:11:dd:ee
  cardIdInput.addEventListener('input', function() {
    const value = this.value;
    const hexRegex = /^[0-9A-F]{2}(?::[0-9A-F]{2})*$/i;
    
    if (value && !hexRegex.test(value)) {
      this.setCustomValidity('Invalid format. Use hex format like aa:bb:cc:11 (hex pairs separated by colons)');
    } else {
      this.setCustomValidity('');
    }
  });

  // Number of bits validation
  nbBitsInput.addEventListener('input', function() {
    const value = parseInt(this.value);
    if (value && (value <= 0)) {
      this.setCustomValidity('Number of bits must be positive and divisible by 8');
    } else {
      this.setCustomValidity('');
    }
  });
  {% endif %}

  // Validity period toggle
  validityEnabledCheckbox.addEventListener('change', function() {
    validityStartInput.disabled = !this.checked;
    validityEndInput.disabled = !this.checked;
  });

  // Initialize validity inputs state
  validityStartInput.disabled = !validityEnabledCheckbox.checked;
  validityEndInput.disabled = !validityEnabledCheckbox.checked;
});
</script>
{% endblock %} 
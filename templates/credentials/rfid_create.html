{% extends "base.html" %}

{% block title %}Create RFID Card - Leosac Web GUI{% endblock %}
{% block page_title %}Create RFID Card{% endblock %}

{% block content %}
<div class="container-fluid">
  <div class="row">
    <div class="col-12">
      <div class="card">
        <div class="card-header">
          <h3 class="card-title">Create New RFID Card</h3>
        </div>
        <div class="card-body">
          <form method="POST" id="rfid-form">
            <div class="row">
              <div class="col-md-6">
                <fieldset>
                  <legend>Configuration</legend>
                  
                  <div class="form-group">
                    <label for="alias">Alias *</label>
                    <input type="text" class="form-control" id="alias" name="alias" 
                           placeholder="Card alias" value="{{ credential_data.alias if credential_data else '' }}" required>
                    <small class="form-text text-muted">Enter a name for this RFID card (3-15 characters)</small>
                  </div>

                  <div class="form-group">
                    <label for="card_id">Hexadecimal Card Identifier *</label>
                    <input type="text" class="form-control" id="card_id" name="card_id" 
                           placeholder="00:22:28:c8" value="{{ credential_data.card_id if credential_data else '' }}" required>
                    <small class="form-text text-muted">Enter the RFID card identifier in hex format (e.g., 00:22:28:c8)</small>
                  </div>

                  <div class="form-group">
                    <label for="nb_bits">Number of Bits *</label>
                    <input type="number" class="form-control" id="nb_bits" name="nb_bits" 
                           placeholder="32" value="{{ credential_data.nb_bits if credential_data else '32' }}" required>
                    <small class="form-text text-muted">Enter the number of bits for this card</small>
                  </div>

                  <div class="form-group">
                    <label for="description">Notes</label>
                    <textarea class="form-control" id="description" name="description" rows="2" 
                              placeholder="Additional notes about this card">{{ credential_data.description if credential_data else '' }}</textarea>
                  </div>

                  <div class="form-group">
                    <label for="owner">Owner</label>
                    <select class="form-control" id="owner" name="owner">
                      <option value="">Select a user</option>
                      {% for user in users %}
                      <option value="{{ user.id }}" 
                              {{ 'selected' if credential_data and credential_data.owner == user.id else '' }}>
                        {{ user.username }} ({{ user.firstname }} {{ user.lastname }})
                      </option>
                      {% endfor %}
                    </select>
                  </div>

                  <div class="form-group">
                    <label for="validity_enabled">
                      <input type="checkbox" id="validity_enabled" name="validity_enabled" 
                             {{ 'checked' if credential_data and credential_data.validity_enabled else '' }}>
                      Enable Credential
                    </label>
                  </div>

                  <div class="form-group">
                    <button type="submit" class="btn btn-success">Create RFID Card</button>
                    <a href="{{ url_for('credentials.credentials_list') }}" class="btn btn-secondary">Cancel</a>
                  </div>
                </fieldset>
              </div>
            </div>
          </form>
        </div>
      </div>
    </div>
  </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
  const form = document.getElementById('rfid-form');
  const cardIdInput = document.getElementById('card_id');
  const nbBitsInput = document.getElementById('nb_bits');
  const validityEnabledCheckbox = document.getElementById('validity_enabled');
  const validityStartInput = document.getElementById('validity_start');
  const validityEndInput = document.getElementById('validity_end');

  // Card ID validation - use the same regex as Ember (allows variable length)
  cardIdInput.addEventListener('input', function() {
    const value = this.value;
    const hexRegex = /^[0-9A-F]{2}(?::[0-9A-F]{2})*$/i;
    
    if (value && !hexRegex.test(value)) {
      this.setCustomValidity('Invalid format. Use hex format like 00:22:28:c8 (hex pairs separated by colons)');
    } else {
      this.setCustomValidity('');
    }
  });

  // Number of bits validation
  nbBitsInput.addEventListener('input', function() {
    const value = parseInt(this.value);
    if (value && (value <= 0)) {
      this.setCustomValidity('Number of bits must be positive and divisible by 8');
    } else {
      this.setCustomValidity('');
    }
  });

  // Validity period toggle
  validityEnabledCheckbox.addEventListener('change', function() {
    validityStartInput.disabled = !this.checked;
    validityEndInput.disabled = !this.checked;
  });

  // Initialize validity inputs state
  validityStartInput.disabled = !validityEnabledCheckbox.checked;
  validityEndInput.disabled = !validityEnabledCheckbox.checked;
});
</script>
{% endblock %} 